 
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>选股助手（IE 兼容版）</title>
    <meta name="description" content="IE11 兼容的股票筛选页面" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/theme-chalk/index.css" />
    <link rel="stylesheet" href="http://localhost:5000/static/legacy/legacy.css">
    <!-- 必备 polyfills for IE11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise/dist/es6-promise.auto.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch/dist/fetch.umd.min.js"></script>
    <!-- 题材缓存工具（与主站一致的缓存逻辑） -->
    <script src="http://localhost:5000/static/shared/utils/themesCacheCore.js?v=20250926"></script>
    <!-- 股票代码跳转共享逻辑（与主站一致） -->
    <script src="http://localhost:5000/static/shared/utils/stockLinkCore.js?v=20250926"></script>
    <!-- 因子/数据处理共享核心（与主站一致） -->
    <script src="http://localhost:5000/static/shared/utils/stockFilterCore.js?v=20250926"></script>
    <!-- 股票悬浮提示渲染共享逻辑（与主站一致） -->
    <script src="http://localhost:5000/static/shared/utils/stockTooltipCore.js?v=20250926"></script>
  </head>
  <body>
    {% raw %}
    <div id="app-legacy" class="container" v-cloak>
      <div class="header">
        <div class="title">选股助手</div>
      </div>

      <!-- 筛选区域（简化：特色指标 + 热门题材） -->
      <div class="filters">
        <el-card shadow="never">
          <div slot="header">股票筛选条件</div>

      <!-- 特色指标 tab -->
      <div class="block-gap">
        <div class="section-label">特色指标：</div>
            <el-tag
              v-for="opt in indicatorOptions"
              :key="opt"
              :type="indicator===opt ? 'primary' : 'info'"
              :effect="indicator===opt ? 'dark' : 'plain'"
              class="tag-pill"
              @click="toggleIndicator(opt)">
              {{ opt }}
            </el-tag>
          </div>

          <!-- 热门概念 -->
          <div class="gap-8">
            <div class="section-label">热门概念：</div>
            <div>
              <el-tag
                v-for="t in topThemes"
                :key="t"
                :type="selectedThemes.indexOf(t)>-1 ? 'primary' : 'info'"
                :effect="selectedThemes.indexOf(t)>-1 ? 'dark' : 'plain'"
                class="tag-chip"
                @click="toggleTheme(t)">
                {{ t }}
              </el-tag>
              <el-popover placement="bottom-start" width="360" trigger="click" v-model="factorPopoverVisible['themes']">
                <div class="popover-scroll">
                  <el-checkbox-group v-model="selectedThemes" @change="loadData">
                    <el-checkbox v-for="t in themes.slice(10)" :key="t" :label="t" class="list-item">{{t}}</el-checkbox>
                  </el-checkbox-group>
                </div>
                <el-button slot="reference" size="mini" type="warning" plain>
                  更多({{ themes.length>10 ? themes.length-10 : 0 }})
                </el-button>
              </el-popover>
            </div>
          </div>

          <!-- 基本面 / 技术面 / 资金面 -->
          <div class="mt-12">
            <div class="subsection-label">基本面</div>
            <div>
              <el-popover
                v-for="f in basicFactors"
                :key="'basic-'+f"
                placement="bottom-start"
                width="260"
                trigger="click"
                v-model="factorPopoverVisible[f]"
              >
                <div>
                  <div class="popover-title">选择{{f}}范围</div>
                  <el-radio-group v-model="tempFactorMap[f]" @change="onFactorChange(f)">
                    <el-radio v-for="opt in factorRanges[f] || []" :key="opt" :label="opt" class="list-item">{{opt}}</el-radio>
                  </el-radio-group>
                </div>
                <el-tag slot="reference" :type="isFactorSelected(f)?'success':'info'" :effect="isFactorSelected(f)?'dark':'plain'" :closable="isFactorSelected(f)" @close="removeFactor(f)" class="tag-chip">{{ f }}</el-tag>
              </el-popover>
            </div>

            <div class="subsection-label">技术面</div>
            <div>
              <el-popover
                v-for="f in technicalFactors"
                :key="'tech-'+f"
                placement="bottom-start"
                width="260"
                trigger="click"
                v-model="factorPopoverVisible[f]"
              >
                <div>
                  <div class="popover-title">选择{{f}}范围</div>
                  <el-radio-group v-model="tempFactorMap[f]" @change="onFactorChange(f)">
                    <el-radio v-for="opt in factorRanges[f] || []" :key="opt" :label="opt" class="list-item">{{opt}}</el-radio>
                  </el-radio-group>
                </div>
                <el-tag slot="reference" :type="isFactorSelected(f)?'success':'info'" :effect="isFactorSelected(f)?'dark':'plain'" :closable="isFactorSelected(f)" @close="removeFactor(f)" class="tag-chip">{{ f }}</el-tag>
              </el-popover>
            </div>

            <div class="subsection-label">资金面</div>
            <div>
              <el-popover
                v-for="f in capitalFactors"
                :key="'cap-'+f"
                placement="bottom-start"
                width="260"
                trigger="click"
                v-model="factorPopoverVisible[f]"
              >
                <div>
                  <div class="popover-title">选择{{f}}范围</div>
                  <el-radio-group v-model="tempFactorMap[f]" @change="onFactorChange(f)">
                    <el-radio v-for="opt in factorRanges[f] || []" :key="opt" :label="opt" class="list-item">{{opt}}</el-radio>
                  </el-radio-group>
                </div>
                <el-tag slot="reference" :type="isFactorSelected(f)?'success':'info'" :effect="isFactorSelected(f)?'dark':'plain'" :closable="isFactorSelected(f)" @close="removeFactor(f)" class="tag-chip">{{ f }}</el-tag>
              </el-popover>
            </div>
          </div>

          <div class="filters-summary">
            <span>已选择 {{ selectedCount }} 个筛选条件</span>
            <el-button @click="handleReset">清除条件</el-button>
          </div>
        </el-card>
      </div>

      <!-- 表格区域 -->
      <el-card shadow="never">
          <el-table :data="pagedList" stripe class="table-full">
          <el-table-column
            v-for="col in dataColumns"
            :key="col"
            :prop="col"
            :label="getColumnLabel(col)"
            :width="getColumnWidth(col)"
          >
              <template slot-scope="scope">
                <!-- 股票代码：仅为链接，无悬浮窗 -->
                <a v-if="col==='股票代码'" :href="formatCodeLink(scope.row[col])" @click="onCodeClick($event, scope.row[col])">{{ scope.row[col] }}</a>

                <!-- 股票简称：悬浮展示详情（与主站一致） -->
                <el-popover
                  v-else-if="col==='股票简称'"
                  placement="right"
                  width="360"
                  trigger="hover"
                  @show="onShowDetail(scope.row['股票代码'])"
                >
                  <div v-html="hoverDetailHtml"></div>
                  <span slot="reference">{{ scope.row[col] }}</span>
                </el-popover>

                <!-- 其他列原样显示 -->
                <span v-else>{{ scope.row[col] }}</span>
              </template>
          </el-table-column>
        </el-table>
        <div class="mt12-right">
          <el-pagination
            :current-page.sync="currentPage"
            :page-size.sync="pageSize"
            :total="tableData.length"
            :page-sizes="[10, 20, 50, 100]"
            layout="total, sizes, prev, pager, next, jumper"
          ></el-pagination>
        </div>
      </el-card>
    </div>

    <!-- Vue2 + Element UI for IE11 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/index.js"></script>
        <!-- 主站因子映射全局变量（UMD 全局 + CommonJS） -->
        <script src="http://localhost:5000/static/shared/config/factorMapping.js"></script>
        <!-- 主站因子配置全局变量（UMD 全局 + CommonJS） -->
        <script src="http://localhost:5000/static/shared/config/factorConfig.js"></script>
    <!-- API 适配层（直接调用 web/src 下已实现的代码） -->
    <script src="http://localhost:5000/static/legacy/legacyApi.js"></script>
    <!-- 业务脚本（Vue2 + Element UI 调用 /api 接口） -->
    <script src="http://localhost:5000/static/legacy/legacy.js?v=20250926"></script>

    <!-- 因子范围选择弹窗（复用当前页面实例的数据） -->
    <script>
      (function(){
        var t = setInterval(function(){
          var vm = document.getElementById('app-legacy');
          if (!vm || !vm.__vue__) return;
          var app = vm.__vue__;
          var DialogCtor = Vue.extend({
            props: ['appRef'],
            template: '\
<el-dialog :visible.sync="appRef.factorDialogVisible" :title="appRef.factorDialogTitle" width="420px">\
  <div style="padding:6px 0;">\
    <el-radio-group v-model="appRef.currentFactorValue">\
      <el-radio v-for="opt in appRef.factorRanges[appRef.currentFactorKey] || []" :key="opt" :label="opt" style="display:block;margin:6px 0;">{{opt}}</el-radio>\
    </el-radio-group>\
  </div>\
  <span slot="footer" class="dialog-footer">\
    <el-button @click="appRef.factorDialogVisible=false">取 消</el-button>\
    <el-button @click="appRef.clearFactor">清 除</el-button>\
    <el-button type="primary" @click="appRef.confirmFactor">确 定</el-button>\
  </span>\
</el-dialog>'
          });
          var node = document.createElement('div');
          document.body.appendChild(node);
          new DialogCtor({ propsData: { appRef: app } }).$mount(node);
          clearInterval(t);
        }, 200);
      })();
    </script>
    {% endraw %}
  </body>
  </html>


